services:
  neo4j-db:
    image: neo4j:2025.01.0-community-bullseye
    ports:
      - 7474:7474
      - 7687:7687
    restart: always
    environment:
      NEO4J_AUTH: neo4j/neo4jpass

  supply-chain-db:
    image: apache/age:release_PG16_1.5.0
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - app-db-data:/var/lib/postgresql/data/pgdata

  supply-chain-api:
    image: supply-chain-app:latest
    ports:
      - 8080:8080
    depends_on:
      - supply-chain-db
    env_file:
      - .env
    volumes:
      - type: bind
        source: ./supply_chain_api
        target: /app/supply_chain_api
        read_only: true
      - type: bind
        source: ./common
        target: /app/common
        read_only: true
    build:
      context: ./
      dockerfile: supply_chain_api/Dockerfile
    entrypoint: >
      /bin/bash -c "
      set -e ;
      fastapi run supply_chain_api/main.py --host 0.0.0.0 --port 80 --reload
      "

volumes:
  app-db-data:
